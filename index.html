<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D&D Character Creator</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root { --parchment: #f4e9d0; --dark: #2c1a0e; --red: #8b1a1a; --gold: #c9a84c; --ink: #1a0f00; }
body { background: #1a0f00; font-family: Georgia, serif; color: var(--ink); }

#app { max-width: 860px; margin: 30px auto; padding: 0 16px; }
.header { text-align: center; color: var(--gold); margin-bottom: 24px; }
.header h1 { font-size: 2rem; letter-spacing: 2px; text-shadow: 0 2px 8px #000; }
.header p { color: #c9a84c88; font-style: italic; }
.header-btns { display: flex; gap: 10px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }

.steps-bar { display: flex; justify-content: center; gap: 6px; margin-bottom: 24px; flex-wrap: wrap; }
.step-pill { padding: 6px 14px; border-radius: 20px; font-size: 0.78rem; background: #3a2010; color: #c9a84c88; border: 1px solid #c9a84c33; cursor: pointer; }
.step-pill.active { background: var(--red); color: #fff; border-color: var(--red); }
.step-pill.done { background: #2a4020; color: #7bc47f; border-color: #4a8050; }

.card { background: var(--parchment); border-radius: 8px; padding: 28px; box-shadow: 0 4px 24px #0008; border: 2px solid var(--gold); }
.card h2 { color: var(--red); font-size: 1.3rem; border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 20px; }

.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
@media(max-width: 600px) { .g2, .g3 { grid-template-columns: 1fr; } }

.fg { margin-bottom: 14px; }
label { display: block; font-size: 0.83rem; font-weight: bold; color: var(--dark); margin-bottom: 4px; }
input[type=text], input[type=number], textarea {
  width: 100%; padding: 8px 10px; border: 1px solid #b09060; border-radius: 4px;
  background: #fffdf5; font-family: Georgia, serif; font-size: 0.9rem; color: var(--ink);
}
textarea { resize: vertical; min-height: 68px; }
input:focus, textarea:focus { outline: 2px solid var(--gold); }

.ability-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 12px 0; }
@media(max-width:500px) { .ability-grid { grid-template-columns: repeat(2,1fr); } }
.ab-box { background: #fff8e8; border: 2px solid var(--gold); border-radius: 8px; padding: 10px; text-align: center; }
.ab-name { font-size: 0.72rem; font-weight: bold; color: var(--red); letter-spacing: 1px; text-transform: uppercase; }
.ab-score { width: 58px; font-size: 1.3rem; text-align: center; border: none; border-bottom: 2px solid var(--gold); background: transparent; font-weight: bold; color: var(--ink); }
.ab-mod { font-size: 0.82rem; color: #555; margin-top: 3px; }

.skills-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
.sk-row { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; padding: 2px 0; }
.sk-row input[type=checkbox] { width: 15px; height: 15px; accent-color: var(--red); flex-shrink: 0; }
.sk-bonus { margin-left: auto; font-size: 0.75rem; color: #777; white-space: nowrap; }

.tag-row { display: flex; gap: 8px; margin-bottom: 8px; }
.tag-row input { flex: 1; }
.add-btn { padding: 8px 14px; background: var(--gold); color: var(--dark); border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap; }
.tags { display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px; }
.tag { background: #e8d8a0; border: 1px solid var(--gold); border-radius: 14px; padding: 3px 10px; font-size: 0.82rem; display: flex; align-items: center; gap: 5px; }
.tag button { border: none; background: none; cursor: pointer; color: var(--red); font-size: 1rem; line-height: 1; padding: 0; }

.nav { display: flex; justify-content: space-between; margin-top: 24px; align-items: center; }
.btn { padding: 10px 26px; border-radius: 4px; border: none; cursor: pointer; font-family: Georgia, serif; font-size: 0.92rem; font-weight: bold; }
.btn-back { background: #d4c090; color: var(--dark); }
.btn-next { background: var(--red); color: #fff; }
.btn-gold { background: var(--gold); color: var(--dark); }
.btn-purple { background: #5a2d82; color: #fff; }
.btn-sm { font-size: 0.85rem; padding: 8px 18px; }
.btn:hover { opacity: 0.85; }
.roll-btn { padding: 8px 16px; background: var(--red); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-family: Georgia, serif; margin-bottom: 12px; }

.chips { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
.chip { font-size: 0.7rem; padding: 2px 8px; background: #e8d8a0; border: 1px solid var(--gold); border-radius: 10px; cursor: pointer; color: var(--dark); }
.chip:hover { background: var(--gold); }

/* Sheet */
#sheet { display: none; background: var(--parchment); min-height: 100vh; }
.sheet-inner { max-width: 800px; margin: 0 auto; padding: 30px; }
.sheet-h1 { text-align: center; font-size: 1.8rem; color: var(--red); letter-spacing: 3px; margin-bottom: 4px; }
.sheet-sub { text-align: center; color: #888; font-style: italic; font-size: 0.88rem; margin-bottom: 18px; }
.sec { border: 1px solid var(--gold); border-radius: 6px; padding: 12px; margin-bottom: 14px; }
.sec h3 { color: var(--red); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--gold); padding-bottom: 4px; margin-bottom: 10px; }
.s-row { display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 8px; }
.sf { flex: 1; min-width: 110px; }
.sf label { font-size: 0.65rem; text-transform: uppercase; color: #888; }
.sf .v { border-bottom: 1px solid #ccc; min-height: 22px; font-size: 0.95rem; padding-bottom: 2px; }
.ab-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
.ab-cell { text-align: center; border: 1px solid var(--gold); border-radius: 6px; padding: 6px 10px; min-width: 64px; }
.ab-cell .an { font-size: 0.6rem; color: #888; text-transform: uppercase; }
.ab-cell .as { font-size: 1.4rem; font-weight: bold; }
.ab-cell .am { font-size: 0.8rem; color: var(--red); }
.stag { display: inline-block; background: #e8d8a0; border: 1px solid var(--gold); border-radius: 12px; padding: 2px 9px; font-size: 0.8rem; margin: 2px; }
.sk2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 0.85rem; }
.no-print { display: flex; gap: 10px; justify-content: center; padding: 16px 0; flex-wrap: wrap; }

/* AI Panel */
#aiPanel { display: none; background: #0d0820; min-height: 100vh; }
.ai-inner { max-width: 800px; margin: 0 auto; padding: 30px; }
.ai-header { text-align: center; margin-bottom: 24px; }
.ai-header h1 { color: #b388ff; font-size: 1.8rem; letter-spacing: 2px; text-shadow: 0 0 20px #7c4dff88; }
.ai-header p { color: #7c6a9a; font-style: italic; font-size: 0.9rem; }
.ai-card { background: #1a1030; border: 1px solid #5a2d82; border-radius: 10px; padding: 20px; margin-bottom: 16px; box-shadow: 0 0 20px #7c4dff22; }
.ai-card h3 { color: #b388ff; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #5a2d82; padding-bottom: 6px; margin-bottom: 12px; }
.ai-card p, .ai-card div { color: #e0d0ff; font-size: 0.92rem; line-height: 1.7; }
.ai-name { text-align: center; font-size: 2rem; color: #ffd700; font-style: italic; margin-bottom: 6px; text-shadow: 0 0 15px #ffd70066; }
.ai-class-line { text-align: center; color: #b388ff; font-size: 1rem; margin-bottom: 20px; letter-spacing: 1px; }
.ai-stat-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
.ai-stat { background: #2a1845; border: 1px solid #7c4dff44; border-radius: 8px; padding: 8px 14px; text-align: center; min-width: 70px; }
.ai-stat .sn { font-size: 0.65rem; color: #9c7fc0; text-transform: uppercase; }
.ai-stat .sv { font-size: 1.3rem; font-weight: bold; color: #ffd700; }
.ai-stat .sm { font-size: 0.8rem; color: #b388ff; }
.ai-trait { background: #2a1845; border-left: 3px solid #7c4dff; border-radius: 4px; padding: 8px 12px; margin: 6px 0; color: #e0d0ff; font-size: 0.88rem; line-height: 1.6; }
.loading-wrap { text-align: center; padding: 60px 20px; }
.loading-wrap p { color: #9c7fc0; font-style: italic; margin-top: 16px; font-size: 0.95rem; }
.spinner { width: 48px; height: 48px; border: 4px solid #5a2d82; border-top-color: #b388ff; border-radius: 50%; animation: spin 0.9s linear infinite; margin: 0 auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.api-key-wrap { background: #1a1030; border: 1px solid #5a2d82; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.api-key-wrap label { color: #b388ff; }
.api-key-wrap input { background: #0d0820; border-color: #5a2d82; color: #e0d0ff; }
.api-key-wrap small { color: #7c6a9a; font-size: 0.78rem; display: block; margin-top: 4px; }
.err-box { background: #3a1020; border: 1px solid #c0392b; border-radius: 6px; padding: 14px; color: #ff8a80; font-size: 0.9rem; margin-bottom: 16px; }
.ai-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; padding: 10px 0 20px; }

@media print {
  #app { display: none !important; }
  #aiPanel { display: none !important; }
  #sheet { display: block !important; }
  .no-print { display: none !important; }
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
</style>
</head>
<body>

<div id="app">
  <div class="header">
    <h1>&#9876; Character Creator &#9876;</h1>
    <p>Forge your hero's legend</p>
    <div class="header-btns">
      <button class="btn btn-purple btn-sm" onclick="showAiPanel()">&#10024; Bring to Life with AI</button>
      <button class="btn btn-gold btn-sm" onclick="showSheet()">&#128424; Generate Sheet</button>
    </div>
  </div>
  <div class="steps-bar" id="stepsBar"></div>
  <div class="card" id="stepContent"></div>
</div>

<div id="sheet">
  <div class="sheet-inner" id="sheetContent"></div>
</div>

<div id="aiPanel">
  <div class="ai-inner" id="aiContent"></div>
</div>

<script>
var STEPS = ['Identity','Race & Class','Abilities','Background & Skills','Equipment','Spells','Summary'];
var ABS = ['STR','DEX','CON','INT','WIS','CHA'];

var SUG = {
  alignment: ['Lawful Good','Neutral Good','Chaotic Good','Lawful Neutral','True Neutral','Chaotic Neutral','Lawful Evil','Neutral Evil','Chaotic Evil'],
  race: ['Human','High Elf','Wood Elf','Dark Elf','Hill Dwarf','Mountain Dwarf','Lightfoot Halfling','Stout Halfling','Forest Gnome','Rock Gnome','Half-Elf','Half-Orc','Tiefling','Dragonborn','Aasimar','Goliath','Tabaxi','Kenku','Lizardfolk','Tortle','Firbolg','Triton','Warforged','Changeling'],
  subrace: ['High','Wood','Dark','Duergar','Ghostwise','Svirfneblin','Scourge','Fallen','Protector','Draconblood','Ravenite','Mark of Shadow'],
  class_: ['Barbarian','Bard','Cleric','Druid','Fighter','Monk','Paladin','Ranger','Rogue','Sorcerer','Warlock','Wizard','Artificer','Blood Hunter'],
  subclass: ['Path of the Berserker','Path of the Totem Warrior','College of Lore','College of Valor','Life Domain','Light Domain','War Domain','Circle of the Moon','Champion','Battle Master','Eldritch Knight','Way of the Open Hand','Oath of Devotion','Oath of Vengeance','Hunter Conclave','Thief','Assassin','Arcane Trickster','Draconic Bloodline','Wild Magic','The Fiend','The Great Old One','School of Evocation','School of Abjuration','Alchemist','Artillerist'],
  background: ['Acolyte','Charlatan','Criminal','Spy','Entertainer','Folk Hero','Guild Artisan','Hermit','Noble','Outlander','Sage','Sailor','Soldier','Urchin','Far Traveler','Haunted One'],
  languages: ['Common','Elvish','Dwarvish','Gnomish','Halfling','Orc','Draconic','Infernal','Abyssal','Celestial','Sylvan','Undercommon','Deep Speech','Primordial','Giant','Goblin'],
  spellAbility: ['INT','WIS','CHA'],
  traits: ['I idolize a particular hero and reference their deeds often.','I have a joke for every occasion, even if inappropriate.','I face problems head-on, simple and direct.','Nothing can shake my optimistic attitude.','I am always calm, even in dire situations.','I know a story relevant to almost every situation.'],
  ideals: ['Greater Good — helping others is what life is about.','Freedom — no one should be enslaved or controlled.','Power — I will be powerful enough to make my own rules.','Tradition — the old ways must be respected and preserved.','Aspiration — I will prove my worth to the world.','Honor — if I dishonor myself I dishonor my whole clan.'],
  bonds: ['I would lay down my life for the people I serve.','I owe my life to a mentor who has since passed.','I will protect my home village no matter the cost.','Someone saved my life on the battlefield once.','I seek to recover an ancient artifact that was lost.','I protect those who cannot protect themselves.'],
  flaws: ['I am inflexible in my thinking.','I have difficulty keeping my true feelings hidden.','I have a weakness for gold and fine things.','Violence is my answer to almost any challenge.','I secretly believe everyone is beneath me.','I am slow to trust others, even allies.'],
  equipment: ['Longsword','Shortsword','Dagger','Handaxe','Greataxe','Rapier','Longbow','Shortbow','Light Crossbow','Quarterstaff','Mace','Warhammer','Greatsword','Shield','Leather Armor','Chain Mail','Plate Armor','Studded Leather','Scale Mail','Explorers Pack','Priests Pack','Scholars Pack','Healing Potion','Spell Component Pouch','Arcane Focus','Holy Symbol','Druidic Focus','Thieves Tools','Rope 50ft','Torch x10','Rations x5','Bedroll','Backpack'],
  spells: ['Fire Bolt (C)','Prestidigitation (C)','Eldritch Blast (C)','Sacred Flame (C)','Minor Illusion (C)','Mending (C)','Vicious Mockery (C)','Shillelagh (C)','Magic Missile (1)','Cure Wounds (1)','Burning Hands (1)','Thunderwave (1)','Shield (1)','Hex (1)','Bless (1)','Healing Word (1)','Disguise Self (1)','Detect Magic (1)','Misty Step (2)','Scorching Ray (2)','Hold Person (2)','Invisibility (2)','Spiritual Weapon (2)','Fireball (3)','Lightning Bolt (3)','Counterspell (3)','Hypnotic Pattern (3)','Dispel Magic (3)','Greater Invisibility (4)','Banishment (4)','Wall of Fire (4)','Cone of Cold (5)','Hold Monster (5)','Wall of Force (5)','Wish (9)']
};

var SKILLS = [
  {n:'Acrobatics',a:'DEX'},{n:'Animal Handling',a:'WIS'},{n:'Arcana',a:'INT'},
  {n:'Athletics',a:'STR'},{n:'Deception',a:'CHA'},{n:'History',a:'INT'},
  {n:'Insight',a:'WIS'},{n:'Intimidation',a:'CHA'},{n:'Investigation',a:'INT'},
  {n:'Medicine',a:'WIS'},{n:'Nature',a:'INT'},{n:'Perception',a:'WIS'},
  {n:'Performance',a:'CHA'},{n:'Persuasion',a:'CHA'},{n:'Religion',a:'INT'},
  {n:'Sleight of Hand',a:'DEX'},{n:'Stealth',a:'DEX'},{n:'Survival',a:'WIS'}
];

var cur = 0;
var savedApiKey = '';
var ch = {
  name:'', player:'', alignment:'Lawful Good', level:1, xp:0,
  race:'', subrace:'', class_:'', subclass:'', background:'',
  abilities:{STR:10,DEX:10,CON:10,INT:10,WIS:10,CHA:10},
  profBonus:2, proficiencies:'', skills:[],
  traits:'', ideals:'', bonds:'', flaws:'',
  equipment:[], spells:[],
  spellAbility:'', spellDC:8, spellAtk:'', spellSlots:'', features:'',
  cp:0, sp:0, gp:0, ep:0, pp:0, notes:'', abilityNotes:''
};

function mval(s) { return Math.floor((s - 10) / 2); }
function mstr(s) { var m = mval(s); return (m >= 0 ? '+' : '') + m; }
function he(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function comboField(field, listKey, placeholder) {
  var opts = (SUG[listKey] || []).map(function(o) { return '<option value="' + he(o) + '">'; }).join('');
  var uid = 'dl_' + field + '_' + listKey;
  return '<div style="position:relative">' +
    '<input type="text" list="' + uid + '" value="' + he(ch[field]) + '" placeholder="' + (placeholder || 'Choose or type...') + '" oninput="ch[\'' + field + '\']=this.value">' +
    '<span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none;color:#888;font-size:0.8rem">&#9660;</span>' +
    '<datalist id="' + uid + '">' + opts + '</datalist>' +
    '</div>';
}

function chipRow(field, listKey) {
  return '<div class="chips">' + (SUG[listKey] || []).slice(0, 5).map(function(s) {
    var safe = s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    return '<span class="chip" onclick="appendField(\'' + field + '\',\'' + safe + '\')">' + he(s.length > 38 ? s.slice(0, 38) + '...' : s) + '</span>';
  }).join('') + '</div>';
}

function appendField(field, text) {
  ch[field] = (ch[field] ? ch[field] + '\n' : '') + text;
  var el = document.getElementById('ta_' + field);
  if (el) el.value = ch[field];
}

function renderSteps() {
  var html = '';
  for (var i = 0; i < STEPS.length; i++) {
    var cls = i === cur ? 'active' : i < cur ? 'done' : '';
    html += '<div class="step-pill ' + cls + '" onclick="goTo(' + i + ')">' + (i < cur ? '&#10003; ' : '') + STEPS[i] + '</div>';
  }
  document.getElementById('stepsBar').innerHTML = html;
}

function goTo(i) { cur = i; render(); }
function nav(back) { cur = back ? Math.max(0, cur - 1) : Math.min(STEPS.length - 1, cur + 1); render(); }

function render() {
  renderSteps();
  var fns = [s0, s1, s2, s3, s4, s5, s6];
  document.getElementById('stepContent').innerHTML = fns[cur]();
}

function navBtns() {
  var back = '<button class="btn btn-back" onclick="nav(true)"' + (cur === 0 ? ' style="visibility:hidden"' : '') + '>&#8592; Back</button>';
  var next = '<button class="btn btn-next" onclick="nav(false)">Next &#8594;</button>';
  return '<div class="nav">' + back + next + '</div>';
}

function s0() {
  var html = '<h2>Character Identity</h2>';
  html += '<div class="g2">';
  html += '<div class="fg"><label>Character Name</label><input type="text" value="' + he(ch.name) + '" oninput="ch.name=this.value" placeholder="e.g. Thalindra Moonwhisper"></div>';
  html += '<div class="fg"><label>Player Name</label><input type="text" value="' + he(ch.player) + '" oninput="ch.player=this.value" placeholder="Your name"></div>';
  html += '<div class="fg"><label>Level (1-20)</label><input type="number" min="1" max="20" value="' + ch.level + '" oninput="ch.level=parseInt(this.value)||1;ch.profBonus=Math.ceil(ch.level/4)+1"></div>';
  html += '<div class="fg"><label>Experience Points</label><input type="number" min="0" value="' + ch.xp + '" oninput="ch.xp=parseInt(this.value)||0"></div>';
  html += '<div class="fg"><label>Alignment</label>' + comboField('alignment', 'alignment') + '</div>';
  html += '</div>';
  html += navBtns();
  return html;
}

function s1() {
  var html = '<h2>Race &amp; Class</h2>';
  html += '<div class="g2">';
  html += '<div class="fg"><label>Race</label>' + comboField('race', 'race') + '</div>';
  html += '<div class="fg"><label>Subrace / Variant</label>' + comboField('subrace', 'subrace', 'e.g. High Elf') + '</div>';
  html += '<div class="fg"><label>Class</label>' + comboField('class_', 'class_') + '</div>';
  html += '<div class="fg"><label>Subclass / Archetype</label>' + comboField('subclass', 'subclass', 'e.g. School of Evocation') + '</div>';
  html += '</div>';
  html += navBtns();
  return html;
}

function s2() {
  var html = '<h2>Ability Scores</h2>';
  html += '<button class="roll-btn" onclick="rollAll()">&#127922; Roll 4d6 Drop Lowest</button>';
  html += '<div class="ability-grid">';
  for (var i = 0; i < ABS.length; i++) {
    var a = ABS[i];
    html += '<div class="ab-box">';
    html += '<div class="ab-name">' + a + '</div>';
    html += '<input class="ab-score" type="number" min="1" max="30" value="' + ch.abilities[a] + '" oninput="ch.abilities[\'' + a + '\']=parseInt(this.value)||1;document.getElementById(\'mod_' + a + '\').textContent=mstr(ch.abilities[\'' + a + '\'])">';
    html += '<div class="ab-mod" id="mod_' + a + '">' + mstr(ch.abilities[a]) + '</div>';
    html += '</div>';
  }
  html += '</div>';
  html += '<div class="g2" style="margin-top:12px">';
  html += '<div class="fg"><label>Proficiency Bonus</label><input type="number" min="1" max="9" value="' + ch.profBonus + '" oninput="ch.profBonus=parseInt(this.value)||2" style="max-width:80px"></div>';
  html += '<div class="fg"><label>Bonus Notes</label><textarea oninput="ch.abilityNotes=this.value">' + he(ch.abilityNotes) + '</textarea></div>';
  html += '</div>';
  html += navBtns();
  return html;
}

function s3() {
  var html = '<h2>Background &amp; Skills</h2>';
  html += '<div class="g2">';
  html += '<div class="fg"><label>Background</label>' + comboField('background', 'background') + '</div>';
  html += '<div class="fg"><label>Languages &amp; Proficiencies</label>' + comboField('proficiencies', 'languages', 'Common, Elvish...') + '</div>';
  html += '</div>';
  html += '<div class="fg"><label>Skill Proficiencies</label><div class="skills-grid">';
  for (var i = 0; i < SKILLS.length; i++) {
    var sk = SKILLS[i];
    var prof = ch.skills.indexOf(sk.n) >= 0;
    var bonus = mval(ch.abilities[sk.a]) + (prof ? ch.profBonus : 0);
    var bs = (bonus >= 0 ? '+' : '') + bonus;
    html += '<div class="sk-row">';
    html += '<input type="checkbox"' + (prof ? ' checked' : '') + ' onchange="toggleSkill(\'' + sk.n + '\',this.checked)">';
    html += '<span>' + sk.n + '</span>';
    html += '<span class="sk-bonus">' + bs + ' (' + sk.a + ')</span>';
    html += '</div>';
  }
  html += '</div></div>';
  html += '<div class="g2" style="margin-top:12px">';
  var fields = [['traits','Personality Traits','Describe your personality...'],['ideals','Ideals','What do you believe in?'],['bonds','Bonds','What connects you to the world?'],['flaws','Flaws','Your greatest weakness?']];
  for (var f = 0; f < fields.length; f++) {
    var fd = fields[f];
    html += '<div class="fg"><label>' + fd[1] + '</label>';
    html += '<textarea id="ta_' + fd[0] + '" oninput="ch.' + fd[0] + '=this.value" placeholder="' + fd[2] + '">' + he(ch[fd[0]]) + '</textarea>';
    html += chipRow(fd[0], fd[0]);
    html += '</div>';
  }
  html += '</div>';
  html += navBtns();
  return html;
}

function s4() {
  var html = '<h2>Equipment</h2>';
  html += '<div class="tag-row">';
  html += '<input type="text" id="eq_in" list="dl_eq" placeholder="Type or pick from list, then Add..." onkeydown="if(event.key===\'Enter\')addItem(\'equipment\',\'eq_in\')">';
  html += '<datalist id="dl_eq">' + SUG.equipment.map(function(o) { return '<option value="' + he(o) + '">'; }).join('') + '</datalist>';
  html += '<button class="add-btn" onclick="addItem(\'equipment\',\'eq_in\')">+ Add</button>';
  html += '</div>';
  html += '<div class="tags" style="margin-bottom:14px">';
  for (var i = 0; i < ch.equipment.length; i++) {
    html += '<div class="tag">' + he(ch.equipment[i]) + '<button onclick="removeItem(\'equipment\',' + i + ')">&#215;</button></div>';
  }
  html += '</div>';
  html += '<div class="g3">';
  var coins = [['cp','CP (Copper)'],['sp','SP (Silver)'],['gp','GP (Gold)'],['ep','EP (Electrum)'],['pp','PP (Platinum)']];
  for (var c = 0; c < coins.length; c++) {
    html += '<div class="fg"><label>' + coins[c][1] + '</label><input type="number" min="0" value="' + ch[coins[c][0]] + '" oninput="ch[\'' + coins[c][0] + '\']=parseInt(this.value)||0"></div>';
  }
  html += '</div>';
  html += navBtns();
  return html;
}

function s5() {
  var html = '<h2>Spells &amp; Abilities</h2>';
  html += '<div class="g2" style="margin-bottom:12px">';
  html += '<div class="fg"><label>Spellcasting Ability</label>' + comboField('spellAbility', 'spellAbility', 'INT / WIS / CHA') + '</div>';
  html += '<div class="fg"><label>Spell Save DC</label><input type="number" value="' + ch.spellDC + '" oninput="ch.spellDC=parseInt(this.value)||8"></div>';
  html += '<div class="fg"><label>Spell Attack Bonus</label><input type="text" value="' + he(ch.spellAtk) + '" oninput="ch.spellAtk=this.value" placeholder="e.g. +5"></div>';
  html += '<div class="fg"><label>Spell Slots (e.g. 4/3/2)</label><input type="text" value="' + he(ch.spellSlots) + '" oninput="ch.spellSlots=this.value" placeholder="Lvl1/Lvl2/Lvl3..."></div>';
  html += '</div>';
  html += '<div class="fg"><label>Add Spell / Cantrip</label>';
  html += '<div class="tag-row">';
  html += '<input type="text" id="sp_in" list="dl_sp" placeholder="Type or pick from list, then Add..." onkeydown="if(event.key===\'Enter\')addItem(\'spells\',\'sp_in\')">';
  html += '<datalist id="dl_sp">' + SUG.spells.map(function(o) { return '<option value="' + he(o) + '">'; }).join('') + '</datalist>';
  html += '<button class="add-btn" onclick="addItem(\'spells\',\'sp_in\')">+ Add</button>';
  html += '</div>';
  html += '<div class="tags" style="margin-bottom:12px">';
  for (var i = 0; i < ch.spells.length; i++) {
    html += '<div class="tag">' + he(ch.spells[i]) + '<button onclick="removeItem(\'spells\',' + i + ')">&#215;</button></div>';
  }
  html += '</div></div>';
  html += '<div class="fg"><label>Class Features &amp; Special Abilities</label>';
  html += '<textarea oninput="ch.features=this.value" style="min-height:80px" placeholder="e.g. Rage 2/day, Sneak Attack 3d6...">' + he(ch.features) + '</textarea>';
  html += '</div>';
  html += navBtns();
  return html;
}

function s6() {
  var pb = ch.profBonus;
  var hp = 8 + mval(ch.abilities.CON) + (ch.level - 1) * 5;
  var html = '<h2>Summary</h2>';
  html += '<p style="margin-bottom:14px;color:#555;font-style:italic">Review your character, then choose an option below.</p>';
  html += '<div class="s-row">';
  html += '<div class="sf"><label>Name</label><div class="v">' + he(ch.name || '—') + '</div></div>';
  html += '<div class="sf"><label>Race</label><div class="v">' + he(ch.race || '—') + (ch.subrace ? ' (' + he(ch.subrace) + ')' : '') + '</div></div>';
  html += '<div class="sf"><label>Class</label><div class="v">' + he(ch.class_ || '—') + (ch.subclass ? ' - ' + he(ch.subclass) : '') + '</div></div>';
  html += '<div class="sf"><label>Level</label><div class="v">' + ch.level + '</div></div>';
  html += '<div class="sf"><label>Background</label><div class="v">' + he(ch.background || '—') + '</div></div>';
  html += '<div class="sf"><label>Alignment</label><div class="v">' + he(ch.alignment || '—') + '</div></div>';
  html += '</div>';
  html += '<div class="ab-row" style="margin:10px 0">';
  for (var i = 0; i < ABS.length; i++) {
    var a = ABS[i];
    html += '<div class="ab-cell"><div class="an">' + a + '</div><div class="as">' + ch.abilities[a] + '</div><div class="am">' + mstr(ch.abilities[a]) + '</div></div>';
  }
  html += '</div>';
  html += '<div style="font-size:0.88rem;margin-bottom:14px">Prof Bonus: <strong>+' + pb + '</strong> &nbsp;|&nbsp; Est. HP: <strong>' + hp + '</strong> &nbsp;|&nbsp; Initiative: <strong>' + mstr(ch.abilities.DEX) + '</strong></div>';
  html += '<div class="fg"><label>Additional Notes</label><textarea oninput="ch.notes=this.value" style="min-height:70px">' + he(ch.notes) + '</textarea></div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px">';
  html += '<button onclick="showAiPanel()" style="padding:16px;background:#5a2d82;color:#fff;border:none;border-radius:6px;font-family:Georgia,serif;font-size:0.95rem;font-weight:bold;cursor:pointer">&#10024; Bring to Life with AI</button>';
  html += '<button onclick="showSheet()" style="padding:16px;background:#c9a84c;color:#2c1a0e;border:none;border-radius:6px;font-family:Georgia,serif;font-size:0.95rem;font-weight:bold;cursor:pointer">&#128424; Generate Sheet</button>';
  html += '</div>';
  html += '<div style="margin-top:10px">';
  html += '<button onclick="nav(true)" style="padding:10px 24px;background:#d4c090;color:#2c1a0e;border:none;border-radius:4px;font-family:Georgia,serif;font-size:0.92rem;font-weight:bold;cursor:pointer">&#8592; Back</button>';
  html += '</div>';
  return html;
}

function toggleSkill(name, checked) {
  var idx = ch.skills.indexOf(name);
  if (checked && idx < 0) ch.skills.push(name);
  else if (!checked && idx >= 0) ch.skills.splice(idx, 1);
}

function addItem(type, inputId) {
  var el = document.getElementById(inputId);
  if (!el || !el.value.trim()) return;
  ch[type].push(el.value.trim());
  el.value = '';
  render();
}

function removeItem(type, i) {
  ch[type].splice(i, 1);
  render();
}

function rollAll() {
  for (var i = 0; i < ABS.length; i++) {
    var rolls = [Math.ceil(Math.random()*6), Math.ceil(Math.random()*6), Math.ceil(Math.random()*6), Math.ceil(Math.random()*6)];
    rolls.sort(function(a, b) { return a - b; });
    ch.abilities[ABS[i]] = rolls[1] + rolls[2] + rolls[3];
  }
  render();
}

function showAll(which) {
  document.getElementById('app').style.display = which === 'app' ? 'block' : 'none';
  document.getElementById('sheet').style.display = which === 'sheet' ? 'block' : 'none';
  document.getElementById('aiPanel').style.display = which === 'ai' ? 'block' : 'none';
  window.scrollTo(0, 0);
}

function backToBuilder() { showAll('app'); }

function showSheet() {
  var pb = ch.profBonus;
  var estHP = 8 + mval(ch.abilities.CON) + (ch.level - 1) * 5;
  var pp2 = 10 + mval(ch.abilities.WIS) + (ch.skills.indexOf('Perception') >= 0 ? pb : 0);

  var abCells = '';
  for (var i = 0; i < ABS.length; i++) {
    var a = ABS[i];
    abCells += '<div class="ab-cell"><div class="an">' + a + '</div><div class="as">' + ch.abilities[a] + '</div><div class="am">' + mstr(ch.abilities[a]) + '</div></div>';
  }

  var skHTML = '';
  for (var i = 0; i < SKILLS.length; i++) {
    var sk = SKILLS[i];
    var prof = ch.skills.indexOf(sk.n) >= 0;
    var b = mval(ch.abilities[sk.a]) + (prof ? pb : 0);
    var bs = (b >= 0 ? '+' : '') + b;
    skHTML += '<div><span style="color:' + (prof ? '#8b1a1a' : '#ccc') + ';margin-right:3px">' + (prof ? '&#9679;' : '&#9675;') + '</span>' + sk.n + ' <small style="color:#888">(' + sk.a + ')</small>: <strong>' + bs + '</strong></div>';
  }

  var curr = '';
  var cmap = [['CP',ch.cp],['SP',ch.sp],['GP',ch.gp],['EP',ch.ep],['PP',ch.pp]];
  for (var c = 0; c < cmap.length; c++) { if (cmap[c][1] > 0) curr += cmap[c][0] + ': ' + cmap[c][1] + ' &nbsp; '; }

  var eqTags = ch.equipment.map(function(e) { return '<span class="stag">' + he(e) + '</span>'; }).join('');
  var spTags = ch.spells.map(function(s) { return '<span class="stag">' + he(s) + '</span>'; }).join('');

  var html = '';
  html += '<div class="no-print">';
  html += '<button class="btn btn-gold" onclick="window.print()">&#128424; Print</button>';
  html += '<button class="btn btn-back" onclick="backToBuilder()">&#8592; Builder</button>';
  html += '<button class="btn btn-purple" onclick="showAiPanel()">&#10024; AI Character</button>';
  html += '</div>';
  html += '<div class="sheet-h1">&#9876; Character Sheet &#9876;</div>';
  html += '<div class="sheet-sub">D&amp;D Character Creator</div>';
  html += '<div class="sec"><h3>Identity</h3>';
  html += '<div class="s-row">';
  html += '<div class="sf"><label>Name</label><div class="v">' + he(ch.name || '—') + '</div></div>';
  html += '<div class="sf"><label>Player</label><div class="v">' + he(ch.player || '—') + '</div></div>';
  html += '<div class="sf"><label>Race</label><div class="v">' + he(ch.race || '—') + (ch.subrace ? ' (' + he(ch.subrace) + ')' : '') + '</div></div>';
  html += '</div><div class="s-row">';
  html += '<div class="sf"><label>Class</label><div class="v">' + he(ch.class_ || '—') + (ch.subclass ? ' - ' + he(ch.subclass) : '') + '</div></div>';
  html += '<div class="sf"><label>Level</label><div class="v">' + ch.level + '</div></div>';
  html += '<div class="sf"><label>XP</label><div class="v">' + ch.xp + '</div></div>';
  html += '<div class="sf"><label>Background</label><div class="v">' + he(ch.background || '—') + '</div></div>';
  html += '<div class="sf"><label>Alignment</label><div class="v">' + he(ch.alignment || '—') + '</div></div>';
  html += '</div></div>';
  html += '<div class="sec"><h3>Ability Scores</h3><div class="ab-row">' + abCells + '</div>';
  html += '<div style="font-size:0.85rem;display:flex;gap:16px;flex-wrap:wrap">';
  html += '<span>Proficiency Bonus: <strong>+' + pb + '</strong></span>';
  html += '<span>Initiative: <strong>' + mstr(ch.abilities.DEX) + '</strong></span>';
  html += '<span>Passive Perception: <strong>' + pp2 + '</strong></span>';
  html += '<span>Est. HP: <strong>' + estHP + '</strong></span>';
  html += '</div>' + (ch.abilityNotes ? '<div style="font-size:0.82rem;margin-top:6px;color:#555">' + he(ch.abilityNotes) + '</div>' : '') + '</div>';
  html += '<div class="sec"><h3>Skills</h3><div class="sk2">' + skHTML + '</div>';
  html += (ch.proficiencies ? '<div style="margin-top:6px;font-size:0.83rem"><strong>Languages/Proficiencies:</strong> ' + he(ch.proficiencies) + '</div>' : '') + '</div>';
  html += '<div class="sec"><h3>Character Traits</h3><div class="s-row">';
  html += (ch.traits ? '<div class="sf"><label>Personality Traits</label><div class="v" style="white-space:pre-wrap;font-size:0.88rem">' + he(ch.traits) + '</div></div>' : '');
  html += (ch.ideals ? '<div class="sf"><label>Ideals</label><div class="v" style="white-space:pre-wrap;font-size:0.88rem">' + he(ch.ideals) + '</div></div>' : '');
  html += (ch.bonds ? '<div class="sf"><label>Bonds</label><div class="v" style="white-space:pre-wrap;font-size:0.88rem">' + he(ch.bonds) + '</div></div>' : '');
  html += (ch.flaws ? '<div class="sf"><label>Flaws</label><div class="v" style="white-space:pre-wrap;font-size:0.88rem">' + he(ch.flaws) + '</div></div>' : '');
  html += '</div></div>';
  if (ch.equipment.length) {
    html += '<div class="sec"><h3>Equipment</h3>' + eqTags;
    html += (curr ? '<div style="margin-top:8px;font-size:0.85rem">' + curr + '</div>' : '') + '</div>';
  }
  if (ch.spells.length || ch.features) {
    html += '<div class="sec"><h3>Spells &amp; Abilities</h3>';
    if (ch.spellAbility) html += '<div style="font-size:0.83rem;margin-bottom:6px">Spellcasting: <strong>' + he(ch.spellAbility) + '</strong> | Save DC: <strong>' + ch.spellDC + '</strong> | Atk Bonus: <strong>' + he(ch.spellAtk || '—') + '</strong> | Slots: <strong>' + he(ch.spellSlots || '—') + '</strong></div>';
    if (ch.spells.length) html += '<div style="margin-bottom:8px">' + spTags + '</div>';
    if (ch.features) html += '<div style="font-size:0.85rem;white-space:pre-wrap">' + he(ch.features) + '</div>';
    html += '</div>';
  }
  if (ch.notes) html += '<div class="sec"><h3>Notes</h3><div style="font-size:0.88rem;white-space:pre-wrap">' + he(ch.notes) + '</div></div>';
  html += '<div style="text-align:center;margin-top:18px;font-size:0.73rem;color:#aaa;font-style:italic">May your rolls be ever in your favor &#9876;</div>';

  document.getElementById('sheetContent').innerHTML = html;
  showAll('sheet');
}

function showAiPanel() {
  showAll('ai');
  document.getElementById('aiContent').innerHTML =
    '<div class="ai-header"><h1>&#10024; Character Oracle &#10024;</h1><p>Breathe life into your hero with AI</p></div>' +
    '<div class="api-key-wrap">' +
      '<label>Anthropic API Key</label>' +
      '<input type="password" id="apiKeyInput" value="' + he(savedApiKey) + '" placeholder="sk-ant-..." style="margin-top:4px">' +
      '<small>Your key is used only in your browser and never sent to any server other than Anthropic. Get one free at <strong>console.anthropic.com</strong></small>' +
    '</div>' +
    '<div style="text-align:center;margin-bottom:20px">' +
      '<button onclick="generateCharacter()" style="padding:14px 36px;background:#5a2d82;color:#fff;border:none;border-radius:6px;font-family:Georgia,serif;font-size:1rem;font-weight:bold;cursor:pointer">&#10024; Generate My Character</button>' +
    '</div>' +
    '<div id="aiResult"></div>' +
    '<div class="ai-actions">' +
      '<button class="btn btn-back" onclick="backToBuilder()">&#8592; Back to Builder</button>' +
      '<button class="btn btn-gold" onclick="showSheet()">&#128424; View Sheet</button>' +
    '</div>';
}

function buildPrompt() {
  var profSkills = ch.skills.join(', ') || 'none';
  var eqList = ch.equipment.join(', ') || 'none';
  var spList = ch.spells.join(', ') || 'none';
  var abStr = '';
  for (var i = 0; i < ABS.length; i++) { abStr += ABS[i] + ': ' + ch.abilities[ABS[i]] + ' (' + mstr(ch.abilities[ABS[i]]) + ')  '; }
  return 'You are a creative RPG writer. Based on this D&D character, write a rich character profile.\n\n' +
    'Name: ' + (ch.name || 'Unknown') + '\n' +
    'Race: ' + (ch.race || 'Unknown') + (ch.subrace ? ' (' + ch.subrace + ')' : '') + '\n' +
    'Class: ' + (ch.class_ || 'Unknown') + (ch.subclass ? ' — ' + ch.subclass : '') + '\n' +
    'Level: ' + ch.level + '\n' +
    'Background: ' + (ch.background || 'Unknown') + '\n' +
    'Alignment: ' + (ch.alignment || 'Unknown') + '\n' +
    'Abilities: ' + abStr + '\n' +
    'Skills: ' + profSkills + '\n' +
    'Equipment: ' + eqList + '\n' +
    'Spells: ' + spList + '\n' +
    (ch.features ? 'Features: ' + ch.features + '\n' : '') +
    (ch.traits ? 'Traits: ' + ch.traits + '\n' : '') +
    (ch.ideals ? 'Ideals: ' + ch.ideals + '\n' : '') +
    (ch.bonds ? 'Bonds: ' + ch.bonds + '\n' : '') +
    (ch.flaws ? 'Flaws: ' + ch.flaws + '\n' : '') +
    (ch.notes ? 'Notes: ' + ch.notes + '\n' : '') +
    '\nReturn ONLY a valid JSON object with these exact keys (no markdown, no extra text):\n' +
    '{"epithet":"dramatic subtitle","appearance":"2-3 sentences on looks","personality":"2-3 sentences on demeanor","backstory":"3-4 sentence origin story","motivation":"what drives them","secret":"one hidden truth","quirk":"one memorable habit","combat_style":"how they fight","hook":"one current adventure hook"}';
}

function generateCharacter() {
  var keyEl = document.getElementById('apiKeyInput');
  if (!keyEl) return;
  var key = keyEl.value.trim();
  if (!key) { showAiError('Please enter your Anthropic API key above.'); return; }
  savedApiKey = key;

  document.getElementById('aiResult').innerHTML =
    '<div class="loading-wrap"><div class="spinner"></div><p>The Oracle is writing your legend...<br><small>This may take 10-15 seconds</small></p></div>';

  fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': key,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1200,
      messages: [{ role: 'user', content: buildPrompt() }]
    })
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    if (data.error) { showAiError('API Error: ' + data.error.message); return; }
    var text = '';
    if (data.content) {
      for (var i = 0; i < data.content.length; i++) {
        if (data.content[i].type === 'text') { text = data.content[i].text; break; }
      }
    }
    var parsed = null;
    try {
      var clean = text.replace(/```json/g, '').replace(/```/g, '').trim();
      parsed = JSON.parse(clean);
    } catch(e) {
      showAiError('Could not parse response. Raw output:<br><pre style="font-size:0.75rem;white-space:pre-wrap;color:#e0d0ff;margin-top:8px">' + he(text) + '</pre>');
      return;
    }
    renderAiCharacter(parsed);
  })
  .catch(function(err) {
    showAiError('Network error: ' + err.message + '<br><small>Check your API key and internet connection.</small>');
  });
}

function showAiError(msg) {
  document.getElementById('aiResult').innerHTML = '<div class="err-box">&#9888; ' + msg + '</div>';
}

function renderAiCharacter(p) {
  var pb = ch.profBonus;
  var estHP = 8 + mval(ch.abilities.CON) + (ch.level - 1) * 5;

  var html = '';
  html += '<div class="ai-name">' + he(ch.name || 'Unknown Hero') + '</div>';
  html += '<div class="ai-class-line">' + he(ch.race || '') + ' &nbsp;&#9679;&nbsp; ' + he(ch.class_ || '') + (ch.subclass ? ' (' + he(ch.subclass) + ')' : '') + ' &nbsp;&#9679;&nbsp; Level ' + ch.level + '<br><em style="color:#9c7fc0">' + he(p.epithet || '') + '</em></div>';

  html += '<div class="ai-card"><h3>&#9876; Stats</h3><div class="ai-stat-row">';
  for (var i = 0; i < ABS.length; i++) {
    var a = ABS[i];
    html += '<div class="ai-stat"><div class="sn">' + a + '</div><div class="sv">' + ch.abilities[a] + '</div><div class="sm">' + mstr(ch.abilities[a]) + '</div></div>';
  }
  html += '</div><div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:10px;font-size:0.85rem;color:#b388ff">';
  html += '<span>Prof: <strong style="color:#ffd700">+' + pb + '</strong></span>';
  html += '<span>Est. HP: <strong style="color:#ffd700">' + estHP + '</strong></span>';
  html += '<span>Initiative: <strong style="color:#ffd700">' + mstr(ch.abilities.DEX) + '</strong></span>';
  html += '<span>Alignment: <strong style="color:#ffd700">' + he(ch.alignment) + '</strong></span>';
  html += '</div></div>';

  var sections = [
    ['&#128064; Appearance', p.appearance],
    ['&#128147; Personality', p.personality],
    ['&#128214; Backstory', p.backstory]
  ];
  for (var s = 0; s < sections.length; s++) {
    html += '<div class="ai-card"><h3>' + sections[s][0] + '</h3><div>' + he(sections[s][1] || '') + '</div></div>';
  }

  var traits = [
    ['&#127775; Motivation', p.motivation],
    ['&#9876; Combat Style', p.combat_style],
    ['&#127927; Quirk', p.quirk],
    ['&#128274; Secret', p.secret],
    ['&#127988; Adventure Hook', p.hook]
  ];
  for (var t = 0; t < traits.length; t++) {
    html += '<div class="ai-card"><h3>' + traits[t][0] + '</h3><div class="ai-trait">' + he(traits[t][1] || '') + '</div></div>';
  }

  if (ch.equipment.length) {
    html += '<div class="ai-card"><h3>&#9876; Equipment</h3>';
    for (var e = 0; e < ch.equipment.length; e++) {
      html += '<span class="stag" style="background:#2a1845;border-color:#7c4dff44;color:#e0d0ff">' + he(ch.equipment[e]) + '</span>';
    }
    html += '</div>';
  }

  if (ch.spells.length) {
    html += '<div class="ai-card"><h3>&#10024; Spells</h3>';
    for (var sp = 0; sp < ch.spells.length; sp++) {
      html += '<span class="stag" style="background:#1a2845;border-color:#4d7cff44;color:#b3c8ff">' + he(ch.spells[sp]) + '</span>';
    }
    html += '</div>';
  }

  document.getElementById('aiResult').innerHTML = html;
}

render();
</script>
</body>
</html>
