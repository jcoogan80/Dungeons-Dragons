<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D&D Character Creator</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root { --parchment:#f4e9d0; --dark:#2c1a0e; --red:#8b1a1a; --gold:#c9a84c; --ink:#1a0f00; }
  body { background:#1a0f00; font-family:'Georgia',serif; color:var(--ink); }

  #app { max-width:860px; margin:30px auto; padding:0 16px; }
  .wizard-header { text-align:center; color:var(--gold); margin-bottom:24px; }
  .wizard-header h1 { font-size:2.2rem; letter-spacing:2px; text-shadow:0 2px 8px #000; }
  .wizard-header p { color:#c9a84c99; font-style:italic; }

  .steps-bar { display:flex; justify-content:center; gap:6px; margin-bottom:28px; flex-wrap:wrap; }
  .step-pill { padding:6px 14px; border-radius:20px; font-size:0.78rem; background:#3a2010; color:#c9a84c88; border:1px solid #c9a84c33; cursor:pointer; transition:all .2s; }
  .step-pill.active { background:var(--red); color:#fff; border-color:var(--red); }
  .step-pill.done { background:#2a4020; color:#7bc47f; border-color:#4a8050; }

  .card { background:var(--parchment); border-radius:8px; padding:28px; box-shadow:0 4px 24px #0008; border:2px solid var(--gold); }
  .card h2 { color:var(--red); font-size:1.4rem; border-bottom:2px solid var(--gold); padding-bottom:8px; margin-bottom:20px; }

  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .grid3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
  @media(max-width:600px){ .grid2,.grid3{ grid-template-columns:1fr; } }

  label { display:block; font-size:0.85rem; font-weight:bold; color:var(--dark); margin-bottom:4px; }
  input[type=text], input[type=number], textarea {
    width:100%; padding:8px 10px; border:1px solid #b09060; border-radius:4px;
    background:#fffdf5; font-family:Georgia,serif; font-size:0.92rem; color:var(--ink);
  }
  textarea { resize:vertical; min-height:70px; }
  input:focus, textarea:focus { outline:2px solid var(--gold); }
  .form-group { margin-bottom:14px; }

  .combo-wrap { position:relative; }
  .combo-arrow { position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none; color:#888; font-size:0.8rem; }

  .ability-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
  @media(max-width:500px){ .ability-grid{ grid-template-columns:repeat(2,1fr); } }
  .ability-box { background:#fff8e8; border:2px solid var(--gold); border-radius:8px; padding:12px; text-align:center; }
  .ability-box .ability-name { font-size:0.75rem; font-weight:bold; color:var(--red); letter-spacing:1px; text-transform:uppercase; }
  .ability-box input { width:60px; font-size:1.4rem; text-align:center; border:none; border-bottom:2px solid var(--gold); background:transparent; font-weight:bold; }
  .ability-box .modifier { font-size:0.85rem; color:#555; margin-top:4px; }
  .roll-btn { margin:12px 0; padding:8px 18px; background:var(--red); color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:Georgia,serif; font-size:0.9rem; }
  .roll-btn:hover { background:#a02020; }

  .skills-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
  .skill-row { display:flex; align-items:center; gap:8px; font-size:0.88rem; padding:3px 0; }
  .skill-row input[type=checkbox] { width:16px; height:16px; accent-color:var(--red); }
  .skill-row .skill-mod { font-size:0.75rem; color:#888; margin-left:auto; min-width:32px; text-align:right; }

  .list-input { display:flex; gap:8px; margin-bottom:8px; }
  .list-input > .combo-wrap { flex:1; }
  .add-btn { padding:8px 14px; background:var(--gold); color:var(--dark); border:none; border-radius:4px; cursor:pointer; font-weight:bold; white-space:nowrap; }
  .tag-list { display:flex; flex-wrap:wrap; gap:6px; min-height:32px; }
  .tag { background:#e8d8a0; border:1px solid var(--gold); border-radius:14px; padding:3px 10px; font-size:0.82rem; display:flex; align-items:center; gap:5px; }
  .tag button { border:none; background:none; cursor:pointer; color:var(--red); font-size:1rem; line-height:1; padding:0; }

  .nav-btns { display:flex; justify-content:space-between; margin-top:24px; }
  .btn { padding:10px 28px; border-radius:4px; border:none; cursor:pointer; font-family:Georgia,serif; font-size:0.95rem; font-weight:bold; }
  .btn-back { background:#d4c090; color:var(--dark); }
  .btn-next { background:var(--red); color:#fff; }
  .btn-print { background:var(--gold); color:var(--dark); }
  .btn:hover { opacity:0.85; }

  /* ===== PRINT SHEET (hidden until generated) ===== */
  #sheet { display:none; }
  .sheet-wrap { background:var(--parchment); max-width:800px; margin:0 auto; padding:32px; font-family:Georgia,serif; }
  .sheet-title { text-align:center; font-size:2rem; color:var(--red); letter-spacing:3px; margin-bottom:4px; }
  .sheet-subtitle { text-align:center; color:#888; font-style:italic; margin-bottom:20px; font-size:0.9rem; }
  .sheet-section { border:1px solid var(--gold); border-radius:6px; padding:14px; margin-bottom:16px; }
  .sheet-section h3 { color:var(--red); font-size:1rem; letter-spacing:1px; text-transform:uppercase; border-bottom:1px solid var(--gold); margin-bottom:10px; padding-bottom:4px; }
  .sheet-row { display:flex; flex-wrap:wrap; gap:16px; margin-bottom:8px; }
  .sheet-field { flex:1; min-width:120px; }
  .sheet-field label { font-size:0.7rem; text-transform:uppercase; color:#888; }
  .sheet-field .val { font-size:1rem; border-bottom:1px solid #ccc; min-height:24px; padding-bottom:2px; }
  .ability-row { display:flex; gap:12px; flex-wrap:wrap; }
  .ability-cell { text-align:center; border:1px solid var(--gold); border-radius:6px; padding:8px 12px; min-width:70px; }
  .ability-cell .aname { font-size:0.65rem; color:#888; text-transform:uppercase; }
  .ability-cell .ascore { font-size:1.6rem; font-weight:bold; color:var(--dark); }
  .ability-cell .amod { font-size:0.85rem; color:var(--red); }
  .tag-display { display:flex; flex-wrap:wrap; gap:5px; }
  .tag-display span { background:#e8d8a0; border:1px solid var(--gold); border-radius:12px; padding:2px 10px; font-size:0.82rem; }
  .skills-display { display:grid; grid-template-columns:1fr 1fr; gap:3px; font-size:0.88rem; }
  .skills-display div { padding:2px 0; }
  .print-actions { text-align:center; margin:20px 0; display:flex; gap:12px; justify-content:center; }

  @media print {
    body { background:#fff !important; }
    #app { display:none !important; }
    #sheet { display:block !important; }
    .print-actions { display:none !important; }
    .sheet-wrap { padding:20px; }
    * { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  }
</style>
</head>
<body>

<div id="app">
  <div class="wizard-header">
    <h1>‚öî Character Creator ‚öî</h1>
    <p>Forge your hero's legend</p>
  </div>
  <div class="steps-bar" id="stepsBar"></div>
  <div class="card" id="stepContent"></div>
</div>

<div id="sheet">
  <div class="sheet-wrap" id="sheetContent"></div>
</div>

<script>
const STEPS = ['Identity','Race & Class','Abilities','Background & Skills','Equipment','Spells','Summary'];
const ABILITIES = ['STR','DEX','CON','INT','WIS','CHA'];

const SUGGESTIONS = {
  race:['Human','Elf','High Elf','Wood Elf','Dark Elf (Drow)','Dwarf','Hill Dwarf','Mountain Dwarf','Halfling','Lightfoot Halfling','Stout Halfling','Gnome','Forest Gnome','Rock Gnome','Half-Elf','Half-Orc','Tiefling','Dragonborn','Aasimar','Goliath','Tabaxi','Kenku','Lizardfolk','Tortle','Firbolg','Genasi (Air)','Genasi (Earth)','Genasi (Fire)','Genasi (Water)','Triton','Yuan-ti Pureblood','Changeling','Kalashtar','Shifter','Warforged'],
  subrace:['High','Wood','Dark','Duergar','Drow','Ghostwise','Svirfneblin','Scourge','Fallen','Protector','Mark of Shadow','Mark of Storm','Draconblood','Ravenite'],
  class_:['Barbarian','Bard','Cleric','Druid','Fighter','Monk','Paladin','Ranger','Rogue','Sorcerer','Warlock','Wizard','Artificer','Blood Hunter'],
  subclass:['Path of the Berserker','Path of the Totem Warrior','College of Lore','College of Valor','Life Domain','Light Domain','War Domain','Trickery Domain','Circle of the Land','Circle of the Moon','Champion','Battle Master','Eldritch Knight','Way of the Open Hand','Way of Shadow','Oath of Devotion','Oath of the Ancients','Oath of Vengeance','Hunter','Beast Master','Thief','Assassin','Arcane Trickster','Draconic Bloodline','Wild Magic','The Fiend','The Great Old One','The Archfey','School of Evocation','School of Abjuration','School of Conjuration','Alchemist','Artillerist','Battle Smith'],
  background:['Acolyte','Charlatan','Criminal','Spy','Entertainer','Gladiator','Folk Hero','Guild Artisan','Guild Merchant','Hermit','Noble','Knight','Outlander','Sage','Sailor','Pirate','Soldier','Urchin','Far Traveler','Haunted One','Inquisitor','Archaeologist'],
  alignment:['Lawful Good','Neutral Good','Chaotic Good','Lawful Neutral','True Neutral','Chaotic Neutral','Lawful Evil','Neutral Evil','Chaotic Evil'],
  languages:['Common','Elvish','Dwarvish','Gnomish','Halfling','Orc','Draconic','Infernal','Abyssal','Celestial','Sylvan','Undercommon','Deep Speech','Primordial','Giant','Goblin','Thieves\' Cant'],
  spellAbility:['INT','WIS','CHA','STR','DEX','CON'],
  equipment:['Longsword','Shortsword','Dagger','Handaxe','Greataxe','Rapier','Longbow','Shortbow','Light Crossbow','Quarterstaff','Mace','Warhammer','Greatsword','Shield','Leather Armor','Chain Mail','Plate Armor','Studded Leather','Scale Mail','Explorer\'s Pack','Burglar\'s Pack','Priest\'s Pack','Scholar\'s Pack','Diplomat\'s Pack','Healing Potion','Spell Component Pouch','Arcane Focus','Holy Symbol','Druidic Focus','Thieves\' Tools','Rope (50 ft)','Torch (10)','Rations (5 days)','Bedroll','Backpack'],
  spells:['Cantrip: Fire Bolt','Cantrip: Prestidigitation','Cantrip: Eldritch Blast','Cantrip: Sacred Flame','Cantrip: Mending','Cantrip: Minor Illusion','Cantrip: Shillelagh','Cantrip: Vicious Mockery','1st: Magic Missile','1st: Cure Wounds','1st: Burning Hands','1st: Thunderwave','1st: Shield','1st: Hex','1st: Bless','1st: Healing Word','1st: Disguise Self','1st: Detect Magic','2nd: Misty Step','2nd: Scorching Ray','2nd: Hold Person','2nd: Invisibility','2nd: Shatter','2nd: Spiritual Weapon','3rd: Fireball','3rd: Lightning Bolt','3rd: Counterspell','3rd: Hypnotic Pattern','3rd: Dispel Magic','4th: Banishment','4th: Greater Invisibility','4th: Wall of Fire','5th: Cone of Cold','5th: Hold Monster','5th: Wall of Force','9th: Wish','9th: True Polymorph'],
  traits:['I idolize a particular hero and constantly reference their deeds.','I have a joke for every occasion.','I face problems head-on ‚Äî simple and direct.','I fall in and out of love easily.','I misuse long words to seem more educated.','I know a story relevant to almost every situation.','Nothing can shake my optimistic attitude.','I am always calm, even in dire situations.'],
  ideals:['Greater Good ‚Äî helping others is what life is about.','Tradition ‚Äî respect the old ways.','Freedom ‚Äî no one should be enslaved.','Power ‚Äî I hope to be powerful enough to make my own rules.','Aspiration ‚Äî I will prove my worth to the world.','Live and Let Live ‚Äî don\'t interfere in others\' lives.'],
  bonds:['I have a family but have no idea where they are.','I owe my life to a mentor who has since passed.','I\'ll do anything to protect my home village.','I\'m searching for an ancient artifact.','Someone saved my life on the battlefield.','I protect those who cannot protect themselves.'],
  flaws:['I am inflexible in my thinking.','I secretly believe everyone is beneath me.','I have a weakness for coin.','I am slow to trust members of other races.','Violence is my answer to almost any challenge.','I have difficulty keeping my true feelings hidden.']
};

const SKILLS_LIST = [
  {name:'Acrobatics',ability:'DEX'},{name:'Animal Handling',ability:'WIS'},
  {name:'Arcana',ability:'INT'},{name:'Athletics',ability:'STR'},
  {name:'Deception',ability:'CHA'},{name:'History',ability:'INT'},
  {name:'Insight',ability:'WIS'},{name:'Intimidation',ability:'CHA'},
  {name:'Investigation',ability:'INT'},{name:'Medicine',ability:'WIS'},
  {name:'Nature',ability:'INT'},{name:'Perception',ability:'WIS'},
  {name:'Performance',ability:'CHA'},{name:'Persuasion',ability:'CHA'},
  {name:'Religion',ability:'INT'},{name:'Sleight of Hand',ability:'DEX'},
  {name:'Stealth',ability:'DEX'},{name:'Survival',ability:'WIS'}
];

let cur = 0;
let ch = {
  name:'',player:'',alignment:'Lawful Good',level:1,xp:0,
  race:'',subrace:'',class_:'',subclass:'',background:'',
  abilities:{STR:10,DEX:10,CON:10,INT:10,WIS:10,CHA:10},
  profBonus:2,proficiencies:'',
  skills:[],equipment:[],spells:[],
  traits:'',ideals:'',bonds:'',flaws:'',
  spellAbility:'',spellDC:8,spellAtk:'',spellSlots:'',
  features:'',notes:'',abilityNotes:'',
  cp:0,sp:0,gp:0,ep:0,pp:0
};

function mod(s){ return Math.floor((s-10)/2); }
function modStr(s){ let m=mod(s); return (m>=0?'+':'')+m; }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderSteps(){
  document.getElementById('stepsBar').innerHTML = STEPS.map((s,i)=>
    `<div class="step-pill ${i===cur?'active':i<cur?'done':''}" onclick="goTo(${i})">${i<cur?'‚úì ':''} ${s}</div>`
  ).join('');
}

function goTo(i){ cur=i; render(); }

function render(){
  renderSteps();
  document.getElementById('stepContent').innerHTML = stepHTML(cur);
}

function stepHTML(s){
  switch(s){
    case 0: return stepIdentity();
    case 1: return stepRaceClass();
    case 2: return stepAbilities();
    case 3: return stepBackground();
    case 4: return stepEquipment();
    case 5: return stepSpells();
    case 6: return stepSummary();
  }
}

function nav(back=false){
  cur = back ? Math.max(0,cur-1) : Math.min(STEPS.length-1,cur+1);
  render();
}

function navBtns(isLast=false){
  return `<div class="nav-btns">
    <button class="btn btn-back" onclick="nav(true)" ${cur===0?'style="visibility:hidden"':''}>‚Üê Back</button>
    ${isLast
      ? `<button class="btn btn-print" onclick="showSheet()">üñ® Generate &amp; Print</button>`
      : `<button class="btn btn-next" onclick="nav(false)">Next ‚Üí</button>`}
  </div>`;
}

function dl(id, field, placeholder=''){
  return `<div class="combo-wrap">
    <input type="text" list="${id}" value="${esc(ch[field])}" placeholder="${placeholder}" oninput="ch['${field}']=this.value">
    <span class="combo-arrow">‚ñæ</span>
    <datalist id="${id}">${(SUGGESTIONS[field]||[]).map(o=>`<option value="${esc(o)}">`).join('')}</datalist>
  </div>`;
}

function stepIdentity(){
  return `<h2>Character Identity</h2>
  <div class="grid2">
    <div class="form-group"><label>Character Name</label><input type="text" value="${esc(ch.name)}" oninput="ch.name=this.value" placeholder="Thalindra Moonwhisper"></div>
    <div class="form-group"><label>Player Name</label><input type="text" value="${esc(ch.player)}" oninput="ch.player=this.value" placeholder="Your name"></div>
    <div class="form-group"><label>Level</label><input type="number" min="1" max="20" value="${ch.level}" oninput="ch.level=+this.value;ch.profBonus=Math.ceil(ch.level/4)+1"></div>
    <div class="form-group"><label>Experience Points</label><input type="number" min="0" value="${ch.xp}" oninput="ch.xp=+this.value"></div>
    <div class="form-group"><label>Alignment</label>${dl('dl_alignment','alignment','Choose or type...')}</div>
  </div>
  ${navBtns()}`;
}

function stepRaceClass(){
  return `<h2>Race & Class</h2>
  <div class="grid2">
    <div class="form-group"><label>Race</label>${dl('dl_race','race','Choose or type...')}</div>
    <div class="form-group"><label>Subrace / Variant</label>${dl('dl_subrace','subrace','e.g. High Elf')}</div>
    <div class="form-group"><label>Class</label>${dl('dl_class_','class_','Choose or type...')}</div>
    <div class="form-group"><label>Subclass / Archetype</label>${dl('dl_subclass','subclass','e.g. School of Evocation')}</div>
  </div>
  ${navBtns()}`;
}

function stepAbilities(){
  const boxes = ABILITIES.map(a=>`
    <div class="ability-box">
      <div class="ability-name">${a}</div>
      <input type="number" min="1" max="30" value="${ch.abilities[a]}"
        oninput="ch.abilities['${a}']=+this.value;document.getElementById('mod_${a}').textContent=modStr(ch.abilities['${a}'])">
      <div class="modifier" id="mod_${a}">${modStr(ch.abilities[a])}</div>
    </div>`).join('');
  return `<h2>Ability Scores</h2>
  <button class="roll-btn" onclick="rollAll()">üé≤ Roll 4d6 Drop Lowest (All)</button>
  <div class="ability-grid">${boxes}</div>
  <div style="margin-top:14px">
    <div class="form-group"><label>Proficiency Bonus</label><input type="number" value="${ch.profBonus}" oninput="ch.profBonus=+this.value" style="max-width:80px"></div>
    <div class="form-group"><label>Notes</label><textarea oninput="ch.abilityNotes=this.value">${esc(ch.abilityNotes)}</textarea></div>
  </div>
  ${navBtns()}`;
}

function stepBackground(){
  const skillRows = SKILLS_LIST.map(sk=>{
    const prof = ch.skills.includes(sk.name);
    const bonus = mod(ch.abilities[sk.ability]) + (prof?ch.profBonus:0);
    return `<div class="skill-row">
      <input type="checkbox" ${prof?'checked':''} onchange="toggleSkill('${sk.name}',this.checked)">
      <span>${sk.name}</span>
      <span class="skill-mod">${modStr(bonus)} <small style="color:#aaa">(${sk.ability})</small></span>
    </div>`;
  }).join('');

  function taWithSuggestions(field, listKey, placeholder){
    const chips = (SUGGESTIONS[listKey]||[]).slice(0,4).map(s=>
      `<button type="button" onclick="appendTA('${field}','${s.replace(/'/g,"\\'").replace(/"/g,'&quot;')}')" style="font-size:0.72rem;padding:2px 7px;background:#e8d8a0;border:1px solid #c9a84c;border-radius:10px;cursor:pointer;color:#2c1a0e;margin-top:3px">${s.length>42?s.substring(0,42)+'‚Ä¶':s}</button>`
    ).join(' ');
    return `<textarea id="ta_${field}" oninput="ch.${field}=this.value" placeholder="${placeholder}">${esc(ch[field])}</textarea>
    <div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:3px">${chips}</div>`;
  }

  return `<h2>Background & Skills</h2>
  <div class="grid2">
    <div class="form-group"><label>Background</label>${dl('dl_bg','background','Choose or type...')}</div>
    <div class="form-group"><label>Languages / Proficiencies</label>${dl('dl_lang','languages','Common, Elvish...')}</div>
  </div>
  <div class="form-group"><label>Skill Proficiencies (‚óè = proficient)</label>
    <div class="skills-grid">${skillRows}</div>
  </div>
  <div class="grid2" style="margin-top:12px">
    <div class="form-group"><label>Personality Traits</label>${taWithSuggestions('traits','traits','Describe your personality...')}</div>
    <div class="form-group"><label>Ideals</label>${taWithSuggestions('ideals','ideals','What do you believe in?')}</div>
    <div class="form-group"><label>Bonds</label>${taWithSuggestions('bonds','bonds','What connects you to the world?')}</div>
    <div class="form-group"><label>Flaws</label>${taWithSuggestions('flaws','flaws','What is your greatest weakness?')}</div>
  </div>
  ${navBtns()}`;
}

function appendTA(field, text){
  ch[field] = (ch[field] ? ch[field]+'\n' : '') + text;
  const el = document.getElementById('ta_'+field);
  if(el) el.value = ch[field];
}

function stepEquipment(){
  const tags = ch.equipment.map((e,i)=>`<div class="tag">${esc(e)}<button onclick="removeItem('equipment',${i})">√ó</button></div>`).join('');
  return `<h2>Equipment</h2>
  <div class="list-input">
    <div class="combo-wrap" style="flex:1">
      <input type="text" id="eq_input" list="dl_eq" placeholder="e.g. Longsword, Healing Potion..." onkeydown="if(event.key==='Enter')addItem('equipment','eq_input')">
      <span class="combo-arrow">‚ñæ</span>
      <datalist id="dl_eq">${SUGGESTIONS.equipment.map(o=>`<option value="${esc(o)}">`).join('')}</datalist>
    </div>
    <button class="add-btn" onclick="addItem('equipment','eq_input')">+ Add</button>
  </div>
  <div class="tag-list" style="margin-bottom:16px">${tags}</div>
  <div class="grid3">
    <div class="form-group"><label>CP (Copper)</label><input type="number" min="0" value="${ch.cp}" oninput="ch.cp=+this.value"></div>
    <div class="form-group"><label>SP (Silver)</label><input type="number" min="0" value="${ch.sp}" oninput="ch.sp=+this.value"></div>
    <div class="form-group"><label>GP (Gold)</label><input type="number" min="0" value="${ch.gp}" oninput="ch.gp=+this.value"></div>
    <div class="form-group"><label>EP (Electrum)</label><input type="number" min="0" value="${ch.ep}" oninput="ch.ep=+this.value"></div>
    <div class="form-group"><label>PP (Platinum)</label><input type="number" min="0" value="${ch.pp}" oninput="ch.pp=+this.value"></div>
  </div>
  ${navBtns()}`;
}

function stepSpells(){
  const tags = ch.spells.map((e,i)=>`<div class="tag">${esc(e)}<button onclick="removeItem('spells',${i})">√ó</button></div>`).join('');
  return `<h2>Spells & Abilities</h2>
  <div class="grid2" style="margin-bottom:14px">
    <div class="form-group"><label>Spellcasting Ability</label>${dl('dl_sab','spellAbility','INT / WIS / CHA')}</div>
    <div class="form-group"><label>Spell Save DC</label><input type="number" value="${ch.spellDC}" oninput="ch.spellDC=+this.value"></div>
    <div class="form-group"><label>Spell Attack Bonus</label><input type="text" value="${esc(ch.spellAtk)}" oninput="ch.spellAtk=this.value" placeholder="e.g. +5"></div>
    <div class="form-group"><label>Slots (e.g. 4/3/2/1)</label><input type="text" value="${esc(ch.spellSlots)}" oninput="ch.spellSlots=this.value" placeholder="Lvl1/Lvl2/Lvl3..."></div>
  </div>
  <label>Spells Known / Prepared</label>
  <div class="list-input" style="margin-top:6px">
    <div class="combo-wrap" style="flex:1">
      <input type="text" id="sp_input" list="dl_sp" placeholder="e.g. Fireball (3rd), Eldritch Blast..." onkeydown="if(event.key==='Enter')addItem('spells','sp_input')">
      <span class="combo-arrow">‚ñæ</span>
      <datalist id="dl_sp">${SUGGESTIONS.spells.map(o=>`<option value="${esc(o)}">`).join('')}</datalist>
    </div>
    <button class="add-btn" onclick="addItem('spells','sp_input')">+ Add</button>
  </div>
  <div class="tag-list" style="margin-bottom:14px">${tags}</div>
  <div class="form-group"><label>Special Abilities / Class Features</label>
    <textarea oninput="ch.features=this.value" style="min-height:90px" placeholder="e.g. Rage (2/day), Sneak Attack (3d6)...">${esc(ch.features)}</textarea>
  </div>
  ${navBtns()}`;
}

function stepSummary(){
  const pb = ch.profBonus;
  const hp = 8 + mod(ch.abilities.CON) + (ch.level-1)*5;
  return `<h2>Summary</h2>
  <p style="margin-bottom:16px;color:#555;font-style:italic">Review your character, then click <strong>Generate &amp; Print</strong> to open a print-ready sheet.</p>
  <div class="sheet-row">
    <div class="sheet-field"><label>Name</label><div class="val">${esc(ch.name)||'‚Äî'}</div></div>
    <div class="sheet-field"><label>Race</label><div class="val">${esc(ch.race)||'‚Äî'}${ch.subrace?' ('+esc(ch.subrace)+')':''}</div></div>
    <div class="sheet-field"><label>Class</label><div class="val">${esc(ch.class_)||'‚Äî'}${ch.subclass?' - '+esc(ch.subclass):''}</div></div>
    <div class="sheet-field"><label>Level</label><div class="val">${ch.level}</div></div>
    <div class="sheet-field"><label>Background</label><div class="val">${esc(ch.background)||'‚Äî'}</div></div>
    <div class="sheet-field"><label>Alignment</label><div class="val">${esc(ch.alignment)||'‚Äî'}</div></div>
  </div>
  <div class="ability-row" style="margin:12px 0">
    ${ABILITIES.map(a=>`<div class="ability-cell"><div class="aname">${a}</div><div class="ascore">${ch.abilities[a]}</div><div class="amod">${modStr(ch.abilities[a])}</div></div>`).join('')}
  </div>
  <div style="font-size:0.9rem;margin:8px 0">
    Prof Bonus: <strong>+${pb}</strong> &nbsp;|&nbsp; Est. HP: <strong>${hp}</strong> &nbsp;|&nbsp; Initiative: <strong>${modStr(ch.abilities.DEX)}</strong>
  </div>
  <div class="form-group" style="margin-top:12px"><label>Additional Notes</label>
    <textarea oninput="ch.notes=this.value" style="min-height:80px">${esc(ch.notes)}</textarea>
  </div>
  ${navBtns(true)}`;
}

function toggleSkill(name, checked){
  if(checked){ if(!ch.skills.includes(name)) ch.skills.push(name); }
  else { ch.skills = ch.skills.filter(s=>s!==name); }
}

function addItem(type, inputId){
  const inp = document.getElementById(inputId);
  if(!inp || !inp.value.trim()) return;
  ch[type].push(inp.value.trim());
  inp.value='';
  render();
}

function removeItem(type, i){
  ch[type].splice(i,1);
  render();
}

function rollAll(){
  ABILITIES.forEach(a=>{
    const rolls = [0,1,2,3].map(()=>Math.ceil(Math.random()*6));
    rolls.sort((x,y)=>x-y);
    ch.abilities[a] = rolls.slice(1).reduce((s,n)=>s+n,0);
  });
  render();
}

function showSheet(){
  const pb = ch.profBonus;
  const estHP = 8 + mod(ch.abilities.CON) + (ch.level-1)*5;

  const skillsHTML = SKILLS_LIST.map(sk=>{
    const prof = ch.skills.includes(sk.name);
    const bonus = mod(ch.abilities[sk.ability]) + (prof?pb:0);
    return `<div><span style="color:${prof?'#8b1a1a':'#ccc'};margin-right:4px">${prof?'‚óè':'‚óã'}</span>${sk.name} <small style="color:#888">(${sk.ability})</small>: <strong>${modStr(bonus)}</strong></div>`;
  }).join('');

  const currency = [['CP',ch.cp],['SP',ch.sp],['GP',ch.gp],['EP',ch.ep],['PP',ch.pp]]
    .filter(c=>c[1]>0).map(c=>`${c[0]}: ${c[1]}`).join(' &nbsp; ');

  document.getElementById('sheetContent').innerHTML = `
    <div class="print-actions">
      <button class="btn btn-print" onclick="window.print()">üñ® Print</button>
      <button class="btn btn-back" onclick="backToBuilder()">‚Üê Back to Builder</button>
    </div>
    <div class="sheet-title">‚öî Character Sheet ‚öî</div>
    <div class="sheet-subtitle">Created with D&amp;D Character Creator</div>

    <div class="sheet-section">
      <h3>Identity</h3>
      <div class="sheet-row">
        <div class="sheet-field"><label>Character Name</label><div class="val">${esc(ch.name)||'‚Äî'}</div></div>
        <div class="sheet-field"><label>Player</label><div class="val">${esc(ch.player)||'‚Äî'}</div></div>
        <div class="sheet-field"><label>Race</label><div class="val">${esc(ch.race)||'‚Äî'}${ch.subrace?' ('+esc(ch.subrace)+')':''}</div></div>
      </div>
      <div class="sheet-row">
        <div class="sheet-field"><label>Class</label><div class="val">${esc(ch.class_)||'‚Äî'}${ch.subclass?' ‚Äì '+esc(ch.subclass):''}</div></div>
        <div class="sheet-field"><label>Level</label><div class="val">${ch.level}</div></div>
        <div class="sheet-field"><label>XP</label><div class="val">${ch.xp}</div></div>
        <div class="sheet-field"><label>Background</label><div class="val">${esc(ch.background)||'‚Äî'}</div></div>
        <div class="sheet-field"><label>Alignment</label><div class="val">${esc(ch.alignment)||'‚Äî'}</div></div>
      </div>
    </div>

    <div class="sheet-section">
      <h3>Ability Scores</h3>
      <div class="ability-row">
        ${ABILITIES.map(a=>`<div class="ability-cell"><div class="aname">${a}</div><div class="ascore">${ch.abilities[a]}</div><div class="amod">${modStr(ch.abilities[a])}</div></div>`).join('')}
      </div>
      <div style="margin-top:10px;font-size:0.9rem;display:flex;gap:20px;flex-wrap:wrap">
        <span>Proficiency Bonus: <strong>+${pb}</strong></span>
        <span>Initiative: <strong>${modStr(ch.abilities.DEX)}</strong></span>
        <span>Passive Perception: <strong>${10+mod(ch.abilities.WIS)+(ch.skills.includes('Perception')?pb:0)}</strong></span>
        <span>Est. HP: <strong>${estHP}</strong></span>
      </div>
      ${ch.abilityNotes?`<div style="font-size:0.85rem;margin-top:8px;color:#555">${esc(ch.abilityNotes)}</div>`:''}
    </div>

    <div class="sheet-section">
      <h3>Skills</h3>
      <div class="skills-display">${skillsHTML}</div>
      ${ch.proficiencies?`<div style="margin-top:8px;font-size:0.85rem"><strong>Languages / Proficiencies:</strong> ${esc(ch.proficiencies)}</div>`:''}
    </div>

    <div class="sheet-section">
      <h3>Character Traits</h3>
      <div class="sheet-row">
        ${ch.traits?`<div class="sheet-field"><label>Personality Traits</label><div class="val" style="white-space:pre-wrap">${esc(ch.traits)}</div></div>`:''}
        ${ch.ideals?`<div class="sheet-field"><label>Ideals</label><div class="val" style="white-space:pre-wrap">${esc(ch.ideals)}</div></div>`:''}
        ${ch.bonds?`<div class="sheet-field"><label>Bonds</label><div class="val" style="white-space:pre-wrap">${esc(ch.bonds)}</div></div>`:''}
        ${ch.flaws?`<div class="sheet-field"><label>Flaws</label><div class="val" style="white-space:pre-wrap">${esc(ch.flaws)}</div></div>`:''}
      </div>
    </div>

    ${ch.equipment.length?`
    <div class="sheet-section"><h3>Equipment</h3>
      <div class="tag-display">${ch.equipment.map(e=>`<span>${esc(e)}</span>`).join('')}</div>
      ${currency?`<div style="margin-top:8px;font-size:0.88rem">${currency}</div>`:''}
    </div>`:''}

    ${ch.spells.length||ch.features?`
    <div class="sheet-section"><h3>Spells &amp; Abilities</h3>
      ${ch.spellAbility?`<div style="font-size:0.85rem;margin-bottom:6px">
        Spellcasting: <strong>${esc(ch.spellAbility)}</strong> |
        Save DC: <strong>${ch.spellDC}</strong> |
        Attack Bonus: <strong>${esc(ch.spellAtk)||'‚Äî'}</strong> |
        Slots: <strong>${esc(ch.spellSlots)||'‚Äî'}</strong>
      </div>`:''}
      ${ch.spells.length?`<div class="tag-display" style="margin-bottom:8px">${ch.spells.map(s=>`<span>${esc(s)}</span>`).join('')}</div>`:''}
      ${ch.features?`<div style="font-size:0.88rem;white-space:pre-wrap">${esc(ch.features)}</div>`:''}
    </div>`:''}

    ${ch.notes?`<div class="sheet-section"><h3>Notes</h3><div style="font-size:0.9rem;white-space:pre-wrap">${esc(ch.notes)}</div></div>`:''}

    <div style="text-align:center;margin-top:20px;font-size:0.75rem;color:#aaa;font-style:italic">May your rolls be ever in your favor ‚öî</div>
  `;

  document.getElementById('app').style.display = 'none';
  document.getElementById('sheet').style.display = 'block';
  window.scrollTo(0,0);
}

function backToBuilder(){
  document.getElementById('sheet').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  window.scrollTo(0,0);
}

render();
</script>
</body>
</html>
